import{K as e,w as t,q as s,z as a,M as r,A as o,B as i,D as n,G as c,H as d,I as l,N as u,O as p}from"./firebase-383b8577.js";import{d as h}from"./index-fde0d62d.js";const m={createUserProfile:async(a,r)=>{try{if(!a||!r.email)throw new Error("User ID and email are required");const o={userId:a,email:r.email.toLowerCase().trim(),displayName:r.displayName||`${r.firstName||""} ${r.lastName||""}`.trim()||r.email.split("@")[0],firstName:r.firstName?.trim()||"",lastName:r.lastName?.trim()||"",phone:r.phone||"",address:r.address||"",bio:r.bio||"",photoURL:r.photoURL||"",photoURLType:r.photoURLType||"",department:r.department||"",gradeLevel:r.gradeLevel||"",subjects:r.subjects||"",qualifications:r.qualifications||"",role:r.role||"student",isActive:"admin"===r.role,isEmailVerified:!1,lastLogin:null,approvalStatus:"admin"===r.role?"approved":"pending",submittedAt:e(),approvedAt:"admin"===r.role?e():null,approvedBy:"admin"===r.role?"system":null,rejectionReason:null,subscription:{plan:"free",status:"admin"===r.role?"active":"pending_approval",startDate:"admin"===r.role?e():null,endDate:null,features:{maxRecordings:"admin"===r.role?999:10,maxStorageGB:"admin"===r.role?50:5,canDownload:!0,canShare:"admin"===r.role,canCreateSessions:"admin"===r.role}},usage:{recordingsCount:0,storageUsed:0,sessionsAttended:0,sessionsCreated:0,lastActivity:null,totalTimeSpent:0},preferences:{language:r.language||"en",notifications:{email:!0,push:!0,sessionReminders:!0,recordingAvailable:!0,monthlyReports:!0},theme:"system",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,emailFrequency:"weekly"},createdAt:e(),updatedAt:e(),lastPasswordChange:e(),loginAttempts:0,accountLocked:!1};return await t(s(h,"users",a),o),{success:!0,userId:a,profile:o}}catch(o){throw new Error(`Failed to create user profile: ${o.message}`)}},getUserProfile:async e=>{try{if(!e)throw new Error("User ID is required");const t=await a(s(h,"users",e));if(!t.exists())return null;const r=t.data(),o={id:t.id,...r,createdAt:r.createdAt?.toDate?.(),updatedAt:r.updatedAt?.toDate?.(),lastLogin:r.lastLogin?.toDate?.(),approvedAt:r.approvedAt?.toDate?.(),submittedAt:r.submittedAt?.toDate?.(),lastPasswordChange:r.lastPasswordChange?.toDate?.()};return r.subscription&&(o.subscription={...r.subscription,startDate:r.subscription.startDate?.toDate?.(),endDate:r.subscription.endDate?.toDate?.()}),o}catch(t){throw new Error(`Failed to fetch user profile: ${t.message}`)}},updateUserProfile:async(t,a)=>{try{if(!t)throw new Error("User ID is required");const o=["displayName","firstName","lastName","phone","address","bio","department","gradeLevel","subjects","qualifications","photoURL","photoURLType","preferences","usage"],i={};if(Object.keys(a).forEach(e=>{o.includes(e)&&(i[e]=a[e])}),0===Object.keys(i).length)return{success:!1,userId:t,error:"No valid fields to update",updatedFields:[]};const n={...i,updatedAt:e()};return await r(s(h,"users",t),n),{success:!0,userId:t,updatedFields:Object.keys(i)}}catch(o){throw new Error(`Failed to update user profile: ${o.message}`)}},updateUserAvatar:async(t,a)=>{try{if(!t)throw new Error("User ID is required");const o={photoURL:a.photoURL||"",photoURLType:a.photoURLType||"",updatedAt:e()};return await r(s(h,"users",t),o),{success:!0,userId:t,avatarUpdated:!0}}catch(o){throw new Error(`Failed to update user avatar: ${o.message}`)}},removeUserAvatar:async t=>{try{const a={photoURL:"",photoURLType:"",updatedAt:e()};return await r(s(h,"users",t),a),{success:!0,userId:t,avatarRemoved:!0}}catch(a){throw new Error(`Failed to remove user avatar: ${a.message}`)}},updateLastLogin:async t=>{try{if(!t)return;await r(s(h,"users",t),{lastLogin:e(),"usage.lastActivity":e(),updatedAt:e(),loginAttempts:0,accountLocked:!1})}catch(a){}},incrementUsage:async(t,a,o=1)=>{try{if(!t||!a)return;const i={[`usage.${a}`]:o,updatedAt:e()};await r(s(h,"users",t),i)}catch(i){}},getUserStatistics:async(e,t)=>{try{let s={};switch(t){case"admin":const t=await o(n(h,"users")),a=await o(n(h,"courses")),r=await o(i(n(h,"users"),c("role","==","teacher")));s={totalUsers:t.size,activeCourses:a.size,teachers:r.size,systemHealth:"98%"};break;case"teacher":const d=await o(i(n(h,"courses"),c("teacherId","==",e))),l=await o(i(n(h,"sessions"),c("teacherId","==",e))),u=await o(i(n(h,"users"),c("role","==","student")));s={totalCourses:d.size,sessions:l.size,students:u.size,rating:"4.8/5"};break;case"student":const p=await o(i(n(h,"enrollments"),c("studentId","==",e))),m=await o(i(n(h,"progress"),c("studentId","==",e),c("completed","==",!0))),w=await o(i(n(h,"sessions"),c("students","array-contains",e)));s={enrolledCourses:p.size,completedLessons:m.size,upcomingSessions:w.size,progress:"75%"};break;default:s={}}return s}catch(s){return{totalUsers:0,activeCourses:0,teachers:0,systemHealth:"100%",totalCourses:0,sessions:0,students:0,rating:"0/5",enrolledCourses:0,completedLessons:0,upcomingSessions:0,progress:"0%"}}},validateProfileData:e=>{const t=[];return e.firstName&&e.firstName.length<2&&t.push("First name must be at least 2 characters long"),e.lastName&&e.lastName.length<2&&t.push("Last name must be at least 2 characters long"),e.phone&&!/^[\d\s\-\+\(\)]{10,}$/.test(e.phone)&&t.push("Please enter a valid phone number"),e.bio&&e.bio.length>500&&t.push("Bio must be less than 500 characters"),e.department&&e.department.length>100&&t.push("Department name is too long"),{isValid:0===t.length,errors:t}},getAllUsers:async(e={})=>{try{const{limit:t=50,status:s="all",role:a="all",searchTerm:r="",sortBy:u="createdAt",sortOrder:p="desc"}=e;let m=i(n(h,"users"),d(u,p));"all"!==s&&("pending"===s?m=i(m,c("isActive","==",!1)):"active"===s?m=i(m,c("isActive","==",!0)):"inactive"===s&&(m=i(m,c("approvalStatus","==","deactivated")))),"all"!==a&&(m=i(m,c("role","==",a))),m=i(m,l(t));const w=await o(m),g=[];w.forEach(e=>{const t=e.data();g.push({id:e.id,...t,createdAt:t.createdAt?.toDate?.(),updatedAt:t.updatedAt?.toDate?.(),lastLogin:t.lastLogin?.toDate?.(),approvedAt:t.approvedAt?.toDate?.(),submittedAt:t.submittedAt?.toDate?.()})});let v=g;if(r){const e=r.toLowerCase();v=g.filter(t=>t.email?.toLowerCase().includes(e)||t.displayName?.toLowerCase().includes(e)||t.firstName?.toLowerCase().includes(e)||t.lastName?.toLowerCase().includes(e)||t.phone?.includes(r)||t.department?.toLowerCase().includes(e)||t.subjects?.toLowerCase().includes(e))}return v}catch(t){throw new Error(`Failed to fetch users: ${t.message}`)}},getUsersCount:async()=>{try{const e=await o(n(h,"users")),t=[];e.forEach(e=>{t.push({id:e.id,...e.data()})});return{total:t.length,pending:t.filter(e=>!e.isActive&&"admin"!==e.role).length,active:t.filter(e=>e.isActive).length,deactivated:t.filter(e=>"deactivated"===e.approvalStatus).length,admins:t.filter(e=>"admin"===e.role).length,teachers:t.filter(e=>"teacher"===e.role).length,students:t.filter(e=>"student"===e.role).length,withAvatar:t.filter(e=>e.photoURL).length,withBio:t.filter(e=>e.bio&&e.bio.length>0).length,withPhone:t.filter(e=>e.phone&&e.phone.length>0).length,free:t.filter(e=>"free"===e.subscription?.plan).length,premium:t.filter(e=>"premium"===e.subscription?.plan).length,enterprise:t.filter(e=>"enterprise"===e.subscription?.plan).length,activeToday:t.filter(e=>{const t=e.lastLogin?.toDate?.();return t&&t.toDateString()===(new Date).toDateString()}).length,neverLoggedIn:t.filter(e=>!e.lastLogin).length}}catch(e){throw new Error(`Failed to fetch users count: ${e.message}`)}},approveUser:async(t,a="admin",o="")=>{try{if(!t)throw new Error("User ID is required");const i={isActive:!0,approvalStatus:"approved",approvedAt:e(),approvedBy:a,approvalNotes:o,"subscription.status":"active","subscription.startDate":e(),updatedAt:e()};return await r(s(h,"users",t),i),{success:!0,userId:t,approvedAt:new Date,approvedBy:a}}catch(i){throw new Error(`Failed to approve user: ${i.message}`)}},rejectUser:async(t,a="admin",o="")=>{try{const i={isActive:!1,approvalStatus:"rejected",rejectedAt:e(),rejectedBy:a,rejectionReason:o,updatedAt:e()};return await r(s(h,"users",t),i),{success:!0,userId:t,rejectedAt:new Date,reason:o}}catch(i){throw new Error(`Failed to reject user: ${i.message}`)}},deactivateUser:async(t,a="",o="admin")=>{try{const i={isActive:!1,approvalStatus:"deactivated","subscription.status":"inactive",deactivatedAt:e(),deactivatedBy:o,deactivationReason:a,updatedAt:e()};return await r(s(h,"users",t),i),{success:!0,userId:t,deactivatedAt:new Date,reason:a}}catch(i){throw new Error(`Failed to deactivate user: ${i.message}`)}},reactivateUser:async(t,a="admin")=>{try{const o={isActive:!0,approvalStatus:"approved","subscription.status":"active",reactivatedAt:e(),reactivatedBy:a,updatedAt:e()};return await r(s(h,"users",t),o),{success:!0,userId:t,reactivatedAt:new Date}}catch(o){throw new Error(`Failed to reactivate user: ${o.message}`)}},changeUserRole:async(t,a,o="admin")=>{try{const i=["admin","teacher","student"];if(!i.includes(a))throw new Error(`Invalid role: ${a}. Must be one of: ${i.join(", ")}`);const n={role:a,roleChangedAt:e(),roleChangedBy:o,updatedAt:e()};return"admin"===a&&(n.isActive=!0,n.approvalStatus="approved",n.approvedAt=e(),n.approvedBy=o,n.subscription={plan:"enterprise",status:"active",startDate:e(),endDate:null,features:{maxRecordings:999,maxStorageGB:100,canDownload:!0,canShare:!0,canCreateSessions:!0}}),await r(s(h,"users",t),n),{success:!0,userId:t,newRole:a,changedAt:new Date}}catch(i){throw new Error(`Failed to change user role: ${i.message}`)}},bulkApproveUsers:async(t,a="admin")=>{try{if(!t.length)return{success:!0,approvedCount:0};const r=u(h),o=e();return t.forEach(e=>{const t=s(h,"users",e);r.update(t,{isActive:!0,approvalStatus:"approved",approvedAt:o,approvedBy:a,"subscription.status":"active","subscription.startDate":o,updatedAt:o})}),await r.commit(),{success:!0,approvedCount:t.length,approvedAt:new Date}}catch(r){throw new Error(`Failed to bulk approve users: ${r.message}`)}},getPendingUsers:async()=>{try{const e=i(n(h,"users"),c("isActive","==",!1),c("approvalStatus","==","pending"),d("createdAt","desc")),t=await o(e),s=[];return t.forEach(e=>{const t=e.data();s.push({id:e.id,...t,createdAt:t.createdAt?.toDate?.(),submittedAt:t.submittedAt?.toDate?.()})}),s}catch(e){throw new Error(`Failed to fetch pending users: ${e.message}`)}},updateUserSubscription:async(t,a)=>{try{const o={subscription:{...a,updatedAt:e()},updatedAt:e()};return await r(s(h,"users",t),o),{success:!0,userId:t,subscription:a}}catch(o){throw new Error(`Failed to update user subscription: ${o.message}`)}},deleteUserProfile:async e=>{try{if(!e)throw new Error("User ID is required");const t=await m.getUserProfile(e);if(!t)throw new Error("User profile not found");if("admin"===t.role)throw new Error("Cannot delete admin users through this method");return await p(s(h,"users",e)),{success:!0,userId:e,deletedAt:new Date}}catch(t){throw new Error(`Failed to delete user profile: ${t.message}`)}},searchUsers:async(e,t="all")=>{try{const s=await m.getAllUsers({limit:1e3});if(!e)return s.slice(0,50);const a=e.toLowerCase();let r=s;return r="all"===t?s.filter(t=>t.email?.toLowerCase().includes(a)||t.displayName?.toLowerCase().includes(a)||t.firstName?.toLowerCase().includes(a)||t.lastName?.toLowerCase().includes(a)||t.phone?.includes(e)||t.userId?.includes(e)||t.department?.toLowerCase().includes(a)||t.subjects?.toLowerCase().includes(a)||t.qualifications?.toLowerCase().includes(a)):s.filter(e=>e[t]?.toString().toLowerCase().includes(a)),r.slice(0,50)}catch(s){throw new Error(`Failed to search users: ${s.message}`)}},exportUserData:async e=>{try{const t=await m.getUserProfile(e);if(!t)throw new Error("User profile not found");const{loginAttempts:s,accountLocked:a,...r}=t;return r}catch(t){throw new Error(`Failed to export user data: ${t.message}`)}}};export{m as u};
