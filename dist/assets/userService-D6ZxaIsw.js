var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,i=(t,a,r)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[a]=r,n=(e,t)=>{for(var a in t||(t={}))s.call(t,a)&&i(e,a,t[a]);if(r)for(var a of r(t))o.call(t,a)&&i(e,a,t[a]);return e},l=(e,r)=>t(e,a(r));import{y as d,h as c,z as u,A as p,q as v,r as h,w as m,t as w,p as g,B as f,v as y,l as A,n as b}from"./firebase-DbUGxvwD.js";import{d as L}from"./index-DEgoYGZl.js";const D={createUserProfile:async(e,t)=>{var a,r;try{if(!e||!t.email)throw new Error("User ID and email are required");const s={userId:e,email:t.email.toLowerCase().trim(),displayName:t.displayName||`${t.firstName||""} ${t.lastName||""}`.trim()||t.email.split("@")[0],firstName:(null==(a=t.firstName)?void 0:a.trim())||"",lastName:(null==(r=t.lastName)?void 0:r.trim())||"",phone:t.phone||"",address:t.address||"",bio:t.bio||"",photoURL:t.photoURL||"",photoURLType:t.photoURLType||"",department:t.department||"",gradeLevel:t.gradeLevel||"",subjects:t.subjects||"",qualifications:t.qualifications||"",role:t.role||"student",isActive:"admin"===t.role,isEmailVerified:!1,lastLogin:null,approvalStatus:"admin"===t.role?"approved":"pending",submittedAt:u(),approvedAt:"admin"===t.role?u():null,approvedBy:"admin"===t.role?"system":null,rejectionReason:null,subscription:{plan:"free",status:"admin"===t.role?"active":"pending_approval",startDate:"admin"===t.role?u():null,endDate:null,features:{maxRecordings:"admin"===t.role?999:10,maxStorageGB:"admin"===t.role?50:5,canDownload:!0,canShare:"admin"===t.role,canCreateSessions:"admin"===t.role}},usage:{recordingsCount:0,storageUsed:0,sessionsAttended:0,sessionsCreated:0,lastActivity:null,totalTimeSpent:0},preferences:{language:t.language||"en",notifications:{email:!0,push:!0,sessionReminders:!0,recordingAvailable:!0,monthlyReports:!0},theme:"system",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,emailFrequency:"weekly"},createdAt:u(),updatedAt:u(),lastPasswordChange:u(),loginAttempts:0,accountLocked:!1};return await b(c(L,"users",e),s),{success:!0,userId:e,profile:s}}catch(s){throw new Error(`Failed to create user profile: ${s.message}`)}},getUserProfile:async e=>{var t,a,r,s,o,i,d,u,p,v,h,m,w,g,f,y;try{if(!e)throw new Error("User ID is required");const b=await A(c(L,"users",e));if(!b.exists())return null;const D=b.data(),U=l(n({id:b.id},D),{createdAt:null==(a=null==(t=D.createdAt)?void 0:t.toDate)?void 0:a.call(t),updatedAt:null==(s=null==(r=D.updatedAt)?void 0:r.toDate)?void 0:s.call(r),lastLogin:null==(i=null==(o=D.lastLogin)?void 0:o.toDate)?void 0:i.call(o),approvedAt:null==(u=null==(d=D.approvedAt)?void 0:d.toDate)?void 0:u.call(d),submittedAt:null==(v=null==(p=D.submittedAt)?void 0:p.toDate)?void 0:v.call(p),lastPasswordChange:null==(m=null==(h=D.lastPasswordChange)?void 0:h.toDate)?void 0:m.call(h)});return D.subscription&&(U.subscription=l(n({},D.subscription),{startDate:null==(g=null==(w=D.subscription.startDate)?void 0:w.toDate)?void 0:g.call(w),endDate:null==(y=null==(f=D.subscription.endDate)?void 0:f.toDate)?void 0:y.call(f)})),U}catch(b){throw new Error(`Failed to fetch user profile: ${b.message}`)}},updateUserProfile:async(e,t)=>{try{if(!e)throw new Error("User ID is required");const a=["displayName","firstName","lastName","phone","address","bio","department","gradeLevel","subjects","qualifications","photoURL","photoURLType","preferences","usage"],r={};if(Object.keys(t).forEach(e=>{a.includes(e)&&(r[e]=t[e])}),0===Object.keys(r).length)return{success:!1,userId:e,error:"No valid fields to update",updatedFields:[]};const s=l(n({},r),{updatedAt:u()});return await p(c(L,"users",e),s),{success:!0,userId:e,updatedFields:Object.keys(r)}}catch(a){throw new Error(`Failed to update user profile: ${a.message}`)}},updateUserAvatar:async(e,t)=>{try{if(!e)throw new Error("User ID is required");const a={photoURL:t.photoURL||"",photoURLType:t.photoURLType||"",updatedAt:u()};return await p(c(L,"users",e),a),{success:!0,userId:e,avatarUpdated:!0}}catch(a){throw new Error(`Failed to update user avatar: ${a.message}`)}},removeUserAvatar:async e=>{try{const t={photoURL:"",photoURLType:"",updatedAt:u()};return await p(c(L,"users",e),t),{success:!0,userId:e,avatarRemoved:!0}}catch(t){throw new Error(`Failed to remove user avatar: ${t.message}`)}},updateLastLogin:async e=>{try{if(!e)return;await p(c(L,"users",e),{lastLogin:u(),"usage.lastActivity":u(),updatedAt:u(),loginAttempts:0,accountLocked:!1})}catch(t){}},incrementUsage:async(e,t,a=1)=>{try{if(!e||!t)return;const r={[`usage.${t}`]:a,updatedAt:u()};await p(c(L,"users",e),r)}catch(r){}},getUserStatistics:async(e,t)=>{try{let a={};switch(t){case"admin":const t=await g(h(L,"users")),r=await g(h(L,"courses")),s=await g(v(h(L,"users"),m("role","==","teacher")));a={totalUsers:t.size,activeCourses:r.size,teachers:s.size,systemHealth:"98%"};break;case"teacher":const o=await g(v(h(L,"courses"),m("teacherId","==",e))),i=await g(v(h(L,"sessions"),m("teacherId","==",e))),n=await g(v(h(L,"users"),m("role","==","student")));a={totalCourses:o.size,sessions:i.size,students:n.size,rating:"4.8/5"};break;case"student":const l=await g(v(h(L,"enrollments"),m("studentId","==",e))),d=await g(v(h(L,"progress"),m("studentId","==",e),m("completed","==",!0))),c=await g(v(h(L,"sessions"),m("students","array-contains",e)));a={enrolledCourses:l.size,completedLessons:d.size,upcomingSessions:c.size,progress:"75%"};break;default:a={}}return a}catch(a){return{totalUsers:0,activeCourses:0,teachers:0,systemHealth:"100%",totalCourses:0,sessions:0,students:0,rating:"0/5",enrolledCourses:0,completedLessons:0,upcomingSessions:0,progress:"0%"}}},validateProfileData:e=>{const t=[];return e.firstName&&e.firstName.length<2&&t.push("First name must be at least 2 characters long"),e.lastName&&e.lastName.length<2&&t.push("Last name must be at least 2 characters long"),e.phone&&!/^[\d\s\-\+\(\)]{10,}$/.test(e.phone)&&t.push("Please enter a valid phone number"),e.bio&&e.bio.length>500&&t.push("Bio must be less than 500 characters"),e.department&&e.department.length>100&&t.push("Department name is too long"),{isValid:0===t.length,errors:t}},getAllUsers:async(e={})=>{try{const{limit:t=50,status:a="all",role:r="all",searchTerm:s="",sortBy:o="createdAt",sortOrder:i="desc"}=e;let d=v(h(L,"users"),w(o,i));"all"!==a&&("pending"===a?d=v(d,m("isActive","==",!1)):"active"===a?d=v(d,m("isActive","==",!0)):"inactive"===a&&(d=v(d,m("approvalStatus","==","deactivated")))),"all"!==r&&(d=v(d,m("role","==",r))),d=v(d,y(t));const c=await g(d),u=[];c.forEach(e=>{var t,a,r,s,o,i,d,c,p,v;const h=e.data();u.push(l(n({id:e.id},h),{createdAt:null==(a=null==(t=h.createdAt)?void 0:t.toDate)?void 0:a.call(t),updatedAt:null==(s=null==(r=h.updatedAt)?void 0:r.toDate)?void 0:s.call(r),lastLogin:null==(i=null==(o=h.lastLogin)?void 0:o.toDate)?void 0:i.call(o),approvedAt:null==(c=null==(d=h.approvedAt)?void 0:d.toDate)?void 0:c.call(d),submittedAt:null==(v=null==(p=h.submittedAt)?void 0:p.toDate)?void 0:v.call(p)}))});let p=u;if(s){const e=s.toLowerCase();p=u.filter(t=>{var a,r,o,i,n,l,d;return(null==(a=t.email)?void 0:a.toLowerCase().includes(e))||(null==(r=t.displayName)?void 0:r.toLowerCase().includes(e))||(null==(o=t.firstName)?void 0:o.toLowerCase().includes(e))||(null==(i=t.lastName)?void 0:i.toLowerCase().includes(e))||(null==(n=t.phone)?void 0:n.includes(s))||(null==(l=t.department)?void 0:l.toLowerCase().includes(e))||(null==(d=t.subjects)?void 0:d.toLowerCase().includes(e))})}return p}catch(t){throw new Error(`Failed to fetch users: ${t.message}`)}},getUsersCount:async()=>{try{const e=await g(h(L,"users")),t=[];e.forEach(e=>{t.push(n({id:e.id},e.data()))});return{total:t.length,pending:t.filter(e=>!e.isActive&&"admin"!==e.role).length,active:t.filter(e=>e.isActive).length,deactivated:t.filter(e=>"deactivated"===e.approvalStatus).length,admins:t.filter(e=>"admin"===e.role).length,teachers:t.filter(e=>"teacher"===e.role).length,students:t.filter(e=>"student"===e.role).length,withAvatar:t.filter(e=>e.photoURL).length,withBio:t.filter(e=>e.bio&&e.bio.length>0).length,withPhone:t.filter(e=>e.phone&&e.phone.length>0).length,free:t.filter(e=>{var t;return"free"===(null==(t=e.subscription)?void 0:t.plan)}).length,premium:t.filter(e=>{var t;return"premium"===(null==(t=e.subscription)?void 0:t.plan)}).length,enterprise:t.filter(e=>{var t;return"enterprise"===(null==(t=e.subscription)?void 0:t.plan)}).length,activeToday:t.filter(e=>{var t,a;const r=null==(a=null==(t=e.lastLogin)?void 0:t.toDate)?void 0:a.call(t);return r&&r.toDateString()===(new Date).toDateString()}).length,neverLoggedIn:t.filter(e=>!e.lastLogin).length}}catch(e){throw new Error(`Failed to fetch users count: ${e.message}`)}},approveUser:async(e,t="admin",a="")=>{try{if(!e)throw new Error("User ID is required");const r={isActive:!0,approvalStatus:"approved",approvedAt:u(),approvedBy:t,approvalNotes:a,"subscription.status":"active","subscription.startDate":u(),updatedAt:u()};return await p(c(L,"users",e),r),{success:!0,userId:e,approvedAt:new Date,approvedBy:t}}catch(r){throw new Error(`Failed to approve user: ${r.message}`)}},rejectUser:async(e,t="admin",a="")=>{try{const r={isActive:!1,approvalStatus:"rejected",rejectedAt:u(),rejectedBy:t,rejectionReason:a,updatedAt:u()};return await p(c(L,"users",e),r),{success:!0,userId:e,rejectedAt:new Date,reason:a}}catch(r){throw new Error(`Failed to reject user: ${r.message}`)}},deactivateUser:async(e,t="",a="admin")=>{try{const r={isActive:!1,approvalStatus:"deactivated","subscription.status":"inactive",deactivatedAt:u(),deactivatedBy:a,deactivationReason:t,updatedAt:u()};return await p(c(L,"users",e),r),{success:!0,userId:e,deactivatedAt:new Date,reason:t}}catch(r){throw new Error(`Failed to deactivate user: ${r.message}`)}},reactivateUser:async(e,t="admin")=>{try{const a={isActive:!0,approvalStatus:"approved","subscription.status":"active",reactivatedAt:u(),reactivatedBy:t,updatedAt:u()};return await p(c(L,"users",e),a),{success:!0,userId:e,reactivatedAt:new Date}}catch(a){throw new Error(`Failed to reactivate user: ${a.message}`)}},changeUserRole:async(e,t,a="admin")=>{try{const r=["admin","teacher","student"];if(!r.includes(t))throw new Error(`Invalid role: ${t}. Must be one of: ${r.join(", ")}`);const s={role:t,roleChangedAt:u(),roleChangedBy:a,updatedAt:u()};return"admin"===t&&(s.isActive=!0,s.approvalStatus="approved",s.approvedAt=u(),s.approvedBy=a,s.subscription={plan:"enterprise",status:"active",startDate:u(),endDate:null,features:{maxRecordings:999,maxStorageGB:100,canDownload:!0,canShare:!0,canCreateSessions:!0}}),await p(c(L,"users",e),s),{success:!0,userId:e,newRole:t,changedAt:new Date}}catch(r){throw new Error(`Failed to change user role: ${r.message}`)}},bulkApproveUsers:async(e,t="admin")=>{try{if(!e.length)return{success:!0,approvedCount:0};const a=f(L),r=u();return e.forEach(e=>{const s=c(L,"users",e);a.update(s,{isActive:!0,approvalStatus:"approved",approvedAt:r,approvedBy:t,"subscription.status":"active","subscription.startDate":r,updatedAt:r})}),await a.commit(),{success:!0,approvedCount:e.length,approvedAt:new Date}}catch(a){throw new Error(`Failed to bulk approve users: ${a.message}`)}},getPendingUsers:async()=>{try{const e=v(h(L,"users"),m("isActive","==",!1),m("approvalStatus","==","pending"),w("createdAt","desc")),t=await g(e),a=[];return t.forEach(e=>{var t,r,s,o;const i=e.data();a.push(l(n({id:e.id},i),{createdAt:null==(r=null==(t=i.createdAt)?void 0:t.toDate)?void 0:r.call(t),submittedAt:null==(o=null==(s=i.submittedAt)?void 0:s.toDate)?void 0:o.call(s)}))}),a}catch(e){throw new Error(`Failed to fetch pending users: ${e.message}`)}},updateUserSubscription:async(e,t)=>{try{const a={subscription:l(n({},t),{updatedAt:u()}),updatedAt:u()};return await p(c(L,"users",e),a),{success:!0,userId:e,subscription:t}}catch(a){throw new Error(`Failed to update user subscription: ${a.message}`)}},deleteUserProfile:async e=>{try{if(!e)throw new Error("User ID is required");const t=await D.getUserProfile(e);if(!t)throw new Error("User profile not found");if("admin"===t.role)throw new Error("Cannot delete admin users through this method");return await d(c(L,"users",e)),{success:!0,userId:e,deletedAt:new Date}}catch(t){throw new Error(`Failed to delete user profile: ${t.message}`)}},searchUsers:async(e,t="all")=>{try{const a=await D.getAllUsers({limit:1e3});if(!e)return a.slice(0,50);const r=e.toLowerCase();let s=a;return s="all"===t?a.filter(t=>{var a,s,o,i,n,l,d,c,u;return(null==(a=t.email)?void 0:a.toLowerCase().includes(r))||(null==(s=t.displayName)?void 0:s.toLowerCase().includes(r))||(null==(o=t.firstName)?void 0:o.toLowerCase().includes(r))||(null==(i=t.lastName)?void 0:i.toLowerCase().includes(r))||(null==(n=t.phone)?void 0:n.includes(e))||(null==(l=t.userId)?void 0:l.includes(e))||(null==(d=t.department)?void 0:d.toLowerCase().includes(r))||(null==(c=t.subjects)?void 0:c.toLowerCase().includes(r))||(null==(u=t.qualifications)?void 0:u.toLowerCase().includes(r))}):a.filter(e=>{var a;return null==(a=e[t])?void 0:a.toString().toLowerCase().includes(r)}),s.slice(0,50)}catch(a){throw new Error(`Failed to search users: ${a.message}`)}},exportUserData:async e=>{try{const t=await D.getUserProfile(e);if(!t)throw new Error("User profile not found");const a=t,{loginAttempts:i,accountLocked:n}=a;return((e,t)=>{var a={};for(var i in e)s.call(e,i)&&t.indexOf(i)<0&&(a[i]=e[i]);if(null!=e&&r)for(var i of r(e))t.indexOf(i)<0&&o.call(e,i)&&(a[i]=e[i]);return a})(a,["loginAttempts","accountLocked"])}catch(t){throw new Error(`Failed to export user data: ${t.message}`)}}};export{D as u};
