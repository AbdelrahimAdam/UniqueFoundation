import{B as e,D as t,G as s,H as r,I as o,A as a,z as l,q as d,K as c,P as n,M as u,Q as i,O as m,V as h}from"./firebase-383b8577.js";import{d as p}from"./index-ce15b861.js";const A={getPublishedCourses:async(l={})=>{try{const{limit:d=20,category:c="all",level:n="all",instructorId:u=null}=l;let i=e(t(p,"courses"),s("isPublished","==",!0),r("createdAt","desc"));c&&"all"!==c&&(i=e(i,s("category","==",c))),n&&"all"!==n&&(i=e(i,s("level","==",n))),u&&(i=e(i,s("instructorId","==",u))),d&&d>0&&(i=e(i,o(d)));const m=await a(i),h=[];return m.forEach(e=>{const t=e.data();h.push({id:e.id,...t,createdAt:t.createdAt?.toDate?.(),updatedAt:t.updatedAt?.toDate?.(),publishedAt:t.publishedAt?.toDate?.()})}),h}catch(d){throw new Error(`Failed to fetch published courses: ${d.message}`)}},getAllCourses:async(l={})=>{try{const{limit:d=50,category:c="all",level:n="all",isPublished:u=!0}=l;let i=e(t(p,"courses"),s("isPublished","==",!0),r("createdAt","desc"));"all"!==c&&(i=e(i,s("category","==",c))),"all"!==n&&(i=e(i,s("level","==",n))),d&&d>0&&(i=e(i,o(d)));const m=await a(i),h=[];return m.forEach(e=>{const t=e.data();h.push({id:e.id,...t,createdAt:t.createdAt?.toDate?.(),updatedAt:t.updatedAt?.toDate?.(),publishedAt:t.publishedAt?.toDate?.()})}),h}catch(d){throw new Error(`Failed to fetch courses: ${d.message}`)}},getEnrolledCourses:async(c,n={})=>{try{if(!c)throw new Error("Student ID is required");const{limit:i=50,status:m="all"}=n;let h;h="all"===m?e(t(p,"enrollments"),s("studentId","==",c),r("enrolledAt","desc")):e(t(p,"enrollments"),s("studentId","==",c),s("status","==",m),r("enrolledAt","desc")),i&&i>0&&(h=e(h,o(i)));const A=await a(h),w=[];for(const e of A.docs){const t=e.data(),s=t.courseId;try{const r=await l(d(p,"courses",s));if(r.exists()){const s=r.data();w.push({id:r.id,...s,enrollmentId:e.id,enrollmentStatus:t.status,enrolledAt:t.enrolledAt?.toDate?.(),progress:t.progress||0,lastAccessed:t.lastAccessed?.toDate?.(),completedAt:t.completedAt?.toDate?.(),createdAt:s.createdAt?.toDate?.(),updatedAt:s.updatedAt?.toDate?.()})}}catch(u){}}return w}catch(u){throw new Error(`Failed to fetch enrolled courses: ${u.message}`)}},getCourseById:async(r,o=null)=>{try{if(!r)throw new Error("Course ID is required");const n=await l(d(p,"courses",r));if(!n.exists())return null;const u=n.data();if(!u.isPublished)return null;const i={id:n.id,...u,createdAt:u.createdAt?.toDate?.(),updatedAt:u.updatedAt?.toDate?.(),publishedAt:u.publishedAt?.toDate?.()};if(o)try{const l=e(t(p,"enrollments"),s("studentId","==",o),s("courseId","==",r)),d=await a(l);if(!d.empty){const e=d.docs[0].data();i.enrollment={id:d.docs[0].id,status:e.status,enrolledAt:e.enrolledAt?.toDate?.(),progress:e.progress||0,lastAccessed:e.lastAccessed?.toDate?.(),completedAt:e.completedAt?.toDate?.(),completedModules:e.completedModules||0,totalModules:e.totalModules||0}}}catch(c){}return i}catch(c){throw new Error(`Failed to fetch course: ${c.message}`)}},enrollInCourse:async(r,o,m={})=>{try{if(!r||!o)throw new Error("Course ID and Student ID are required");const h=await l(d(p,"courses",r));if(!h.exists())throw new Error("Course not found");const A=h.data();if(!A.isPublished)throw new Error("Course is not available for enrollment");const w=e(t(p,"enrollments"),s("studentId","==",o),s("courseId","==",r)),g=await a(w);if(!g.empty){const e=g.docs[0].data();throw new Error(`Already enrolled in this course (Status: ${e.status})`)}const f=e(t(p,"modules"),s("courseId","==",r),s("isPublished","==",!0)),y=(await a(f)).size,C={courseId:r,studentId:o,studentEmail:m.email||"",studentName:m.name||"",status:"active",progress:0,enrolledAt:c(),lastAccessed:c(),completedAt:null,totalModules:y,completedModules:0,updatedAt:c()},E=await n(t(p,"enrollments"),C);return await u(d(p,"courses",r),{enrolledStudents:i(o),totalEnrollments:(A.totalEnrollments||0)+1,updatedAt:c()}),{success:!0,enrollmentId:E.id,course:{id:r,title:A.title,instructorName:A.instructorName,totalModules:y}}}catch(h){throw new Error(`Failed to enroll in course: ${h.message}`)}},updateCourseProgress:async(e,t)=>{try{const s={progress:Math.min(Math.max(t.progress||0,0),100),lastAccessed:c(),updatedAt:c()};return void 0!==t.completedModules&&(s.completedModules=Math.max(0,t.completedModules)),s.progress>=100&&(s.status="completed",s.completedAt=c(),s.progress=100),await u(d(p,"enrollments",e),s),{success:!0,enrollmentId:e,progress:s.progress,status:s.status}}catch(s){throw new Error(`Failed to update course progress: ${s.message}`)}},getCourseModules:async(o,l=null)=>{try{const c=e(t(p,"modules"),s("courseId","==",o),s("isPublished","==",!0),r("order","asc")),n=await a(c),u=[];if(n.forEach(e=>{const t=e.data();u.push({id:e.id,...t,createdAt:t.createdAt?.toDate?.(),updatedAt:t.updatedAt?.toDate?.(),isCompleted:!1})}),l)try{const r=e(t(p,"enrollments"),s("studentId","==",l),s("courseId","==",o)),d=await a(r);if(!d.empty){const e=d.docs[0].data().completedModules||[];u.forEach(t=>{t.isCompleted=e.includes(t.id)})}}catch(d){}return u}catch(d){throw new Error(`Failed to fetch course modules: ${d.message}`)}},searchCourses:async(e,t={})=>{try{const s=await A.getAllCourses({limit:1e3});if(!e&&0===Object.keys(t).length)return s.slice(0,50);let r=s;if(e){const t=e.toLowerCase();r=r.filter(e=>e.title?.toLowerCase().includes(t)||e.description?.toLowerCase().includes(t)||e.instructorName?.toLowerCase().includes(t)||e.category?.toLowerCase().includes(t)||(e.tags||[]).some(e=>e.toLowerCase().includes(t)))}return t.category&&"all"!==t.category&&(r=r.filter(e=>e.category===t.category)),t.level&&"all"!==t.level&&(r=r.filter(e=>e.level===t.level)),t.difficulty&&"all"!==t.difficulty&&(r=r.filter(e=>e.difficulty===t.difficulty)),t.instructorId&&(r=r.filter(e=>e.instructorId===t.instructorId)),r.slice(0,50)}catch(s){throw new Error(`Failed to search courses: ${s.message}`)}},getFeaturedCourses:async(o=10)=>{try{const l=e(t(p,"courses"),s("isPublished","==",!0),s("isFeatured","==",!0),r("createdAt","desc"),o(o)),d=await a(l),c=[];return d.forEach(e=>{const t=e.data();c.push({id:e.id,...t,createdAt:t.createdAt?.toDate?.(),updatedAt:t.updatedAt?.toDate?.(),publishedAt:t.publishedAt?.toDate?.()})}),c}catch(l){return A.getPublishedCourses({limit:o})}},getPopularCourses:async(o=10)=>{try{const l=e(t(p,"courses"),s("isPublished","==",!0),r("totalEnrollments","desc"),o(o)),d=await a(l),c=[];return d.forEach(e=>{const t=e.data();c.push({id:e.id,...t,createdAt:t.createdAt?.toDate?.(),updatedAt:t.updatedAt?.toDate?.(),publishedAt:t.publishedAt?.toDate?.()})}),c}catch(l){return A.getPublishedCourses({limit:o})}},unenrollFromCourse:async(e,t,s)=>{try{await m(d(p,"enrollments",e));const r=await l(d(p,"courses",t));if(r.exists()){const e=r.data();await u(d(p,"courses",t),{enrolledStudents:h(s),totalEnrollments:Math.max((e.totalEnrollments||1)-1,0),updatedAt:c()})}return{success:!0,enrollmentId:e,courseId:t}}catch(r){throw new Error(`Failed to unenroll from course: ${r.message}`)}},getStudentCourseStats:async e=>{try{const[t,s]=await Promise.all([A.getEnrolledCourses(e,{limit:1e3}),A.getPublishedCourses({limit:1e3})]),r=t.filter(e=>"completed"===e.enrollmentStatus),o=t.filter(e=>"active"===e.enrollmentStatus);return{totalEnrolled:t.length,totalAvailable:s.length,completedCourses:r.length,inProgressCourses:o.length,averageProgress:t.length>0?Math.round(t.reduce((e,t)=>e+(t.progress||0),0)/t.length):0,recentEnrollments:t.slice(0,5),totalLearningTime:t.reduce((e,t)=>e+(t.estimatedDuration||0),0)}}catch(t){throw new Error(`Failed to fetch student course stats: ${t.message}`)}},markModuleCompleted:async(e,t,s,r)=>{try{const s=await l(d(p,"enrollments",e));if(!s.exists())throw new Error("Enrollment not found");const r=s.data(),o=r.completedModules||[];if(o.includes(t))return{success:!0,alreadyCompleted:!0};const a=[...o,t],n=r.totalModules||1,i=Math.round(a.length/n*100);return await u(d(p,"enrollments",e),{completedModules:a,progress:i,lastAccessed:c(),updatedAt:c(),...i>=100?{status:"completed",completedAt:c()}:{}}),{success:!0,progress:i,completedModules:a.length,totalModules:n,isCourseCompleted:i>=100}}catch(o){throw new Error(`Failed to mark module as completed: ${o.message}`)}}};export{A as c};
